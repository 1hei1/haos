## 分页

分页是将物理内存划分为大小相同的小片段，在x86将一页内存分为4k和4M
每一页可以划分为不同特权级，可以保护操作系统。
如果要启动分页需要启动MMU控制器，启动后每次访问地址都会经过MMU控制器，实现虚拟内存与实际物理地址的映射

页目录：记录每一个页表索引（页表物理地址右移12位）
页表：记录每一个页的索引（页物理地址右移12位）
页：4k/M实际内存空间


## 寻址方式
cpu通过TLB（相当于一种cpu缓存，也被称为快表）来记录虚拟内存与实际物理地址的映射关系，如果cpu通过TLB无法获取对应的映射关系，那么cpu会访问CR3寄存器，同时将虚拟地址拆分为10，10，12位的数据，从中读取页目录的物理地址加上高10位，之后通过内存控制器获取页目录相应页表的物理地址，页表物理地址加上中10位，通过内存控制器获取页的物理地址，页的物理地址加上低12位，通过内存控制器获取实际的物理地址的内容，完成寻址。
![](http://tk.heiblog.top/%E8%99%9A%E6%8B%9F%E5%86%85%E5%AD%98.jpg)


## 设置页表，页目录



页表，页目录每一个单元都为32位，其中20位代表索引，其他的代表权限等信息只需将页目录的地址加载进CR3寄存器就可以，并将CR0寄存器的最高位置1（启动分页）

如：
|物理地址|类目|大小|
|0x1000|页目录|  --4k|
|0x2000|页表1 |  --4k|
|0x3000|页表2 |  --4k|
···
那么页目录里面的索引就可以是2，3


页表，页目录的结构
```c
    u8 present:1; //在内存中
    u8 write:1; //0只读 1可读可写
    u8 user:1;//1所有人0超级用户
    u8 pwt:1;//1直写模式0回写模式
    u8 pcd :1;//禁止该页缓冲
    u8 accessed:1;//被访问过
    u8 dirty:1;//该页缓存被写过
    u8 pat:1;//页大小4k/4m 0/1
    u8 global:1;//全局不可刷新
    u8 ignored:3;//交给操作系统
    u32 index:20;
```