# 任务切换流程：
## 1.通过中断（抢占式切换）
通过定时器产生周期性中断，每次中断发生时，通过idt的任务门获取任务在gdt中的选择子，
之后cpu将当前tr寄存器的所指向的任务的各种状态存储到指向的TSS中，之后通过gdt中的任务描述符，找到对应的任务的位置，将其加载进tr寄存器中，之后cpu将新任务的TSS中存储的寄存器状态存储进个寄存器中，完成任务切换


## 2.手动切换

任务切换的核心是，各个独立，对于每一个任务而言，都有对应的特权级，运行位置。
操作系统实现的是任务之间独立，互不干扰，并且遵循一定调用规则的管理系统

如果任务A要切换到任务B，通过中断到达我们的中断函数，首先将任务A的状态压入A的TSS中，之后从任务队列里找到任务B，将任务B的任务描述符选择子加载进tr寄存器中（选择子是x8后的），通过tr寄存器的值获取新任务的TSS，恢复新任务的TSS,实现任务切换。

![](http://tk.heiblog.top/Snipaste_2023-05-10_09-20-01.jpg)


中断实现任务切换

## 首先启动实时时钟产生周期性中断
    需要设置寄存器A,B其中寄存器A（设置低4位--分频系数），B寄存器（设置第6位---0/1允许/禁止周期性中断）
    note：
        1.在启动中断的时候需要启动中断控制器的相应引脚（即：取消相应引脚的中断屏蔽---相应的ocw位置0）
        2.设置的时候需要屏蔽外中断（即IF位置0），设置完成后启用中断（IF位置1）。
## 设置中断函数
    周期性中断发生时是根据你设计的外部设备中断的起始地址加上8（比如，你设置的起始中断为0x20，那么你的周期性中断的中断号就是0x28）
    通过向中断处理函数表中注册你的中断处理函数完成中断函数设置
    
## 恢复
    中断处理函数结束时，需要读取寄存器C以便下一次中断正常进行
    note:如果外部中断控制器设置的是手动结束中断，需要向主，从片发送0x20结束中断。